# XNAT-OHIF_read-overlay-visualize-segmentation-file

## Context of code
When a user annotate an object and click export on the XNAT, the segmentation will be stored in a stacked dicom file. The file structure is a bit confusing and it took me 2 months to figure it out (I am a novice programmer, so maybe I missed some resources). I didn't find a soloution online, so I created this page. This page aims to read and merge a segmentation generated by XNAT (and perhaps OHIF) so you can validate things locally (with better speed than online servers). 


## Logic of generated segmentation in XNAT
When user add segmentation for each mask, on export, an stacked dicom file will be generated. We can break this into components of:

- data that tell us the address of original image
    - Referrenced series sequence (address of series in the original image)
    - Referrence instance sequnce (address of slice in the original image)
    - (another object that may be used to understand the corresponding slice) the image position patient can also tell us the slice location (the height in axial, or .... perhaps)

- A dictionary that tells us the label for each segmentation number (the XNAT will turn user-defined names to numbers and use this number for segmentation data)
- the segmentation data
    - segmenation pixel (i.e. the manual segmentation image drawn by annotator )
    - segmenation number

The logic behind this is that every object (series or slice) has a referrenced UID in the segmenation which you can use to find the corresponding slice and series in the original image. I breaked this for your (and myself) below so you can follow the logic to read and merge the segmenation and corrosponding image.

#### Find and link the series number 
- there is reference for series number (which points to the series number in the original CT/MRI). Here is the guide for objects in dicom headers so you can find them and use them to link segmentation with original file
    - In SEG (segmentation file): (0008, 1115) with the name of Referenced Series Sequence has an object of (0020, 000E) with the name of Series Instance UID. There is another similar tag of series instance UID in the segmentation file but this is the UID for the segmenation itself and not the corrosponding imaging series.
    - In original CT: (0020, 000E) with the name of Series Instance UID

